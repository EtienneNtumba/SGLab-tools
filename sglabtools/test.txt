# SGLab-tools: Package Python Professionnel pour la Comparaison de GÃ©nomes

"""
DÃ©veloppÃ© par Etienne Ntumba Kabongo
Sous la supervision du Prof. Dr. Simon Grandjean Lapierre
Et du co-superviseur Prof. Dr. Martin Smith

Ce projet vise Ã  fournir un outil automatisÃ©, modulaire, reproductible et documentÃ© pour :
- Alignement de gÃ©nomes
- DÃ©tection de diffÃ©rences
- Masquage des rÃ©gions non fiables
- Comptage de scÃ©narios dâ€™Ã©volution
- RÃ©sumÃ© de la divergence inter-gÃ©nomique
"""

# === sglabtools/cli.py ===
import typer
from sglabtools import run_pipeline

app = typer.Typer(help="""
SGLab-tools ğŸ§¬

Un outil professionnel de comparaison de gÃ©nomes permettant :
- Alignement pair-Ã -pair de gÃ©nomes avec minimap2
- Extraction et classification des diffÃ©rences (SNPs, InDels, gaps, N)
- Application de masques Ã  partir de fichiers BED
- Comptage des scÃ©narios de variation
- Fusion et comparaison multi-gÃ©nomes

DÃ©veloppÃ© par Etienne Ntumba Kabongo (UniversitÃ© de MontrÃ©al)
Sous la direction de :
- Prof. Dr. Simon Grandjean Lapierre
- Prof. Dr. Martin Smith

Exemples dâ€™usage :
$ sglab run sample.txt                  # ExÃ©cute tout le pipeline
$ sglab count --input fichier.tsv       # Compte les scÃ©narios sur un fichier TSV
$ sglab mask --input fichier.tsv --ref H37Rv.bed --query L1.bed
$ sglab merge                           # Fusionne les fichiers de scÃ©narios
""")

@app.command("run")
def run_pipeline_cmd(sample_file: str = typer.Argument(..., help="Fichier TSV contenant les paires Ref / Lx")):
    """Lancer le pipeline complet (alignement + transformation + masque + comptage + fusion)"""
    run_pipeline.run_all(sample_file)

@app.command("mask")
def mask_cmd(
    input: str = typer.Option(..., "--input", help="Fichier TSV des diffÃ©rences initiales"),
    ref: str = typer.Option(..., "--ref", help="Fichier BED de la souche de rÃ©fÃ©rence"),
    query: str = typer.Option(..., "--query", help="Fichier BED de la souche comparÃ©e")
):
    """Appliquer les masques BED Ã  un fichier de diffÃ©rences"""
    from sglabtools.mask import apply_mask
    apply_mask(input, ref, query)

@app.command("count")
def count_cmd(input: str = typer.Option(..., "--input", help="Fichier TSV de diffÃ©rences masquÃ©es")):
    """Compter les scÃ©narios de variation Ã  partir dâ€™un fichier TSV"""
    from sglabtools.count import count_scenarios
    count_scenarios(input)

@app.command("merge")
def merge_cmd():
    """Fusionner tous les fichiers de scÃ©narios en un seul tableau comparatif"""
    from sglabtools.merge import merge_counts
    merge_counts()

if __name__ == "__main__":
    app()

# === sglabtools/run_pipeline.py ===
import os
from sglabtools import transform, mask, count, merge

def run_all(sample_file):
    """
    ExÃ©cution complÃ¨te du pipeline pour chaque paire Ref vs Lx dÃ©finie dans sample.txt
    Ã‰tapes :
    1. VÃ©rification des fichiers .fasta
    2. Alignement avec minimap2
    3. Extraction des diffÃ©rences
    4. Application des masques
    5. Comptage des scÃ©narios
    6. Fusion finale
    """
    with open(sample_file, 'r') as f:
        next(f)  # Ignorer l'entÃªte
        for line in f:
            ref, lx = line.strip().split()
            print(f"\nğŸ§¬ Traitement : {ref} vs {lx}")
            ref_fa = f"{ref}.fasta"
            lx_fa = f"{lx}.fasta"
            if not os.path.exists(ref_fa) or not os.path.exists(lx_fa):
                print(f"âŒ Fichier manquant : {ref_fa} ou {lx_fa}")
                continue

            # Ã‰tape 1 : Alignement
            paf_file = f"alignments_{ref}_{lx}.paf"
            os.system(f"minimap2 -x asm5 -c {ref_fa} {lx_fa} > {paf_file}")
            print(f"âœ… Alignement produit : {paf_file}")

            # Ã‰tape 2 : Extraction des diffÃ©rences
            table = transform.paf_to_table(ref_fa, lx_fa, paf_file)

            # Ã‰tape 3 : Masquage BED
            masked = mask.apply_mask(table, f"{ref}.bed", f"{lx}.bed")

            # Ã‰tape 4 : Comptage des scÃ©narios
            count.count_scenarios(masked)

    # Ã‰tape 5 : Fusion finale
    merge.merge_counts()
    print("\nğŸ“Š Fusion des scÃ©narios complÃ©tÃ©e.")
